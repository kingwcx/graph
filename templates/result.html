{% extends 'index_nav.html' %}

{% block content %}
    <div class="row visible-sm visible-xs">
        <div  class="col-sm-4 col-xs-12 pull-left" style="left:0;position: absolute; Z-INDEX:2;">
            <span><i class="fa fa-list"></i></span>
        </div>
    </div>
    <div class="row visible-sm visible-xs">
        <div class="col-sm-4 col-xs-12 pull-right" style="right:0;position: absolute; Z-INDEX:2;">
            <span><i class="fa fa-list"></i></span>
        </div>
    </div>
    <div class="row visible-md visible-lg">
        <div class="col-lg-2 col-md-3 col-sm-4 col-xs-12 pull-right" style="left:0;position: absolute; Z-INDEX:2;">
            <div id="result-panel" class="panel panel-info  visible-md visible-lg">
                <div id="result-panel-head" class="panel-heading">
                    <label>搜索结果</label> <span class="pull-right"><i id="result-panel-span" class="fa fa-angle-down"></i></span>
                </div>
                <ul id="result-panel-body" class="list-group">
                {% for key,value in data.items %}
                    {% if forloop.counter <= 10 %}
                        <li id="{{ key }}" class="list-group-item">
                            <span class="label label-info">{{ forloop.counter }}</span> {{ value }}
                        </li>
                    {% endif %}
                {% endfor %}
                 </ul>
            </div>
        </div>
    </div>
    <div class="row visible-md visible-lg">
        <div class="col-lg-2 col-md-3 col-sm-4 col-xs-12 pull-right  visible-md visible-lg" style="right:0;position: absolute; Z-INDEX:2;">
            <div id="panel" class="panel panel-info">
                <div id="panel-head" class="panel-heading">
                    <label>结果详情</label><span  class="pull-right"><i id="panel-span" class="fa fa-angle-down"></i></span>
                </div>
                <div id="panel-body" class="panel-body">
                    <p>...</p>
                    <form action="{% url 'front:object_detail' %}" method="post">
                        <input id="panel-input" name="id" type="text" class="hidden">
                        <button id="panel-button" type="submit" class="btn btn-info center-block">查看详情</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div id="cy" class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="height: 600px; text-align: initial;background-color: #2aabd2"></div>
    </div>
    <script>
        var elements;
        var style = [
            { selector: 'node[label = "Design"]',
                style: {
                    'background-color': '#c0fcb0',
                    'content': 'data(name)',
                    'height': '50px',
                    'width': '50px',
                    //'text-valign': 'center',
                    //'text-halign': 'center',
                }
            },
            { selector: 'node[label = "Pattern"]',
                style: {
                    'background-color': '#6FB1FC',
                    'content': 'data(name)',
                    'height': '50px',
                    'width': '50px',
                    //'text-valign': 'center',
                    //'text-halign': 'center',
                    }
            },
            { selector: 'node[label = "Style"]',
                style: {
                    'background-color': '#00fce0',
                    'content': 'data(name)',
                    'height': '50px',
                    'width': '50px',
                    //'text-valign': 'center',
                    //'text-halign': 'center',
                    }
            },
            { selector: 'node[label = "Technology"]',
                style: {
                    'background-color': '#39fc9b',
                    'content': 'data(name)',
                    'height': '50px',
                    'width': '50px',
                    //'text-valign': 'center',
                    //'text-halign': 'center',
                    }
            },
            { selector: 'node[label = "Example"]',
                style: {
                    'background-color': '#fcee48',
                    'content': 'data(name)',
                    'height': '40px',
                    'width': '40px',
                    //'text-valign': 'center',
                    //'text-halign': 'center',
                    }
            },
            { selector: 'edge',
                style: {
                    'content': 'data(relationship)',
                    'curve-style': 'bezier',
                    'target-arrow-shape': 'triangle'}
            },
            { selector: '.eh-hover',
                style: {
                'background-color': 'red'
                }
            },

        ];
        function edit_panel(current_data)
        {
            $("#panel-head label:first").text(current_data.property.name);
            var txt1=$("<p></p>").text(current_data.property.description);  // 使用 jQuery 创建文本
            $("#panel-body p:first").remove();
            $("#panel-body").prepend(txt1);        // 追加新元素

            $("#panel-input").attr({"value" : current_data.id,});
        }
        function highlight_node(node)
        {
            node.animate({
                      style: {
                          backgroundColor: 'red',
                          width: '60px',
                          height: '60px'
                      }
                }, {
                    duration: 500
                });
        }
        function create_graph(data){
            elements = data.elements;
            var cy = cytoscape({
                container: document.getElementById('cy'),
                style:style,
                elements:elements,
            });
            var layout = cy.layout({
                name: 'concentric',
                fit:false,
                padding: 30, // the padding on fit
                startAngle:4/ 2 * Math.PI, // where nodes start in radians
                sweep: undefined, // how many radians should be between the first and last node (defaults to full circle)
                clockwise: true, // whether the layout should go clockwise (true) or counterclockwise/anticlockwise (false)
                equidistant: false, // whether levels have an equal radial distance betwen them, may cause bounding box overflow
                minNodeSpacing: 180 ,// min spacing between outside of nodes (used for radius adjustment)
            });
            layout.run();
            return cy;
        }
        $(function(){
        　　$("#{{ ids.0 }}").addClass("active");
            $("#{{ ids.0 }}").trigger("click");
        });

        $("li").click(function(){
            $("li").removeClass("active");
            $(this).addClass("active");
            $.post("{% url 'admin:find_node' %}",
            {
                id:$(this).attr('id'),
            },
                function(data){
                edit_panel(data.current_data);
                cy = create_graph(data);
                str1 = "[id ='" + data.current_data.id + "']";
                node = cy.nodes(str1);
                highlight_node(node);
                cy.on('tap', 'node', function(evt){
                    var node = evt.target;
                    console.log( 'tapped ' + node);
                    $.post("{% url 'admin:find_node' %}",
                    {
                        id:node.id(),
                    },
                        function(data) {
                            str = "[id !='" + node.id() + "']";
                            node = cy.nodes(str);
                            cy.remove(str);
                            cy.add(data.elements);
                            var layout = cy.layout({
                                name: 'concentric',
                                fit:false,
                                padding: 30, // the padding on fit
                                startAngle:4/ 2 * Math.PI, // where nodes start in radians
                                sweep: undefined, // how many radians should be between the first and last node (defaults to full circle)
                                clockwise: true, // whether the layout should go clockwise (true) or counterclockwise/anticlockwise (false)
                                equidistant: false, // whether levels have an equal radial distance betwen them, may cause bounding box overflow
                                minNodeSpacing: 180 ,// min spacing between outside of nodes (used for radius adjustment)
                            });
                            layout.run();

                            edit_panel(data.current_data);
                        });
                    highlight_node(node);
                });
            });
        });
        $("#result-panel-span").click(function(){
            $("#result-panel-body").slideToggle();
        });
        $("#panel-span").click(function(){
            $("#panel-body").slideToggle();
        });
    </script>
{% endblock %}